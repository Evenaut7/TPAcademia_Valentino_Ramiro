@page "/reportesAlumnos"
@rendermode InteractiveServer
@using QuestPDF.Fluent
@using QuestPDF.Infrastructure
@inject CursoApiClient CursoApiClient
@inject AlumnoInscripcionApiClient AlumnoInscripcionApiClient
@inject PersonaApiClient PersonaApiClient
@inject ComisionApiClient ComisionApiClient
@inject MateriaApiClient MateriaApiClient
@inject UsuarioApiClient UsuarioApiClient
@inject IJSRuntime js
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Reportes de Alumnos</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Reporte de Alumnos por Curso</h3>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">Seleccionar Curso:</label>
        @if (cursos == null)
        {
            <p><em>Cargando cursos...</em></p>
        }
        else if (!cursos.Any())
        {
            <p class="text-muted">No hay cursos disponibles</p>
        }
        else
        {
            <select class="form-select" @bind="cursoSeleccionadoId" @bind:event="onchange">
                <option value="0">-- Seleccione un Curso --</option>
                @foreach (var curso in cursos)
                {
                    <option value="@curso.Id">
                        @GetMateriaDesc(curso.MateriaId) - @GetComisionDesc(curso.ComisionId) (@curso.AnioCalendario)
                    </option>
                }
            </select>
        }
    </div>
    <div class="col-md-6 d-flex align-items-end gap-2">
        <button class="btn btn-success" @onclick="GenerarReporte" disabled="@(cursoSeleccionadoId == 0 || cargando)">
            @if (cargando)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="bi bi-file-pdf"></i> Generar Reporte
        </button>
        <button class="btn btn-primary" @onclick="DescargarPDF" disabled="@(alumnosReporte == null || alumnosReporte.Count == 0 || cargando)">
            <i class="bi bi-cloud-download"></i> Descargar PDF
        </button>
    </div>
</div>

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert @(esError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = string.Empty"></button>
    </div>
}

@if (alumnosReporte != null && alumnosReporte.Count > 0)
{
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@nombreCursoReporte</h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <p><strong>Materia:</strong> @materiaCursoReporte</p>
                    <p><strong>Comisión:</strong> @comisionCursoReporte</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Profesor:</strong> @profesorCursoReporte</p>
                    <p><strong>Total de Alumnos:</strong> <span class="badge bg-primary">@alumnosReporte.Count</span></p>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Nº</th>
                            <th>Apellido</th>
                            <th>Nombre</th>
                            <th>Legajo</th>
                            <th class="text-center">Nota</th>
                            <th class="text-center">Condición</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int numero = 1;
                            foreach (var alumno in alumnosReporte)
                            {
                                var colorCondicion = ObtenerColorCondicion(alumno.Condicion);
                                <tr>
                                    <td>@numero</td>
                                    <td>@alumno.Apellido</td>
                                    <td>@alumno.Nombre</td>
                                    <td>@alumno.Legajo</td>
                                    <td class="text-center">
                                        <strong>@(alumno.Nota?.ToString("F1") ?? "Sin nota")</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge @colorCondicion">@alumno.Condicion</span>
                                    </td>
                                </tr>
                                numero++;
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="row mt-4 pt-3 border-top">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-success">Aprobados</h6>
                            <h3 class="text-success">@alumnosReporte.Count(a => a.Condicion.ToLower() == "aprobado")</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-danger">Desaprobados</h6>
                            <h3 class="text-danger">@alumnosReporte.Count(a => a.Condicion.ToLower() == "desaprobado")</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-warning">Sin Nota</h6>
                            <h3 class="text-warning">@alumnosReporte.Count(a => a.Condicion.ToLower() == "no cargada")</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title text-primary">Nota Promedio</h6>
                            <h3 class="text-primary">
                                @(alumnosReporte.Where(a => a.Nota.HasValue && a.Nota > 0).Any()
                                    ? alumnosReporte.Where(a => a.Nota.HasValue && a.Nota > 0).Average(a => a.Nota.Value).ToString("F2")
                                    : "N/A")
                            </h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-muted">
                <small>Reporte generado el @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")</small>
            </div>
        </div>
    </div>
}

@code {
    private List<CursoDTO>? cursos;
    private List<MateriaDTO>? materias;
    private List<ComisionDTO>? comisiones;

    private int cursoSeleccionadoId = 0;
    private string mensaje = string.Empty;
    private bool esError = false;
    private bool cargando = false;

    private List<AlumnoReporte>? alumnosReporte;
    private string nombreCursoReporte = string.Empty;
    private string materiaCursoReporte = string.Empty;
    private string comisionCursoReporte = string.Empty;
    private string profesorCursoReporte = string.Empty;

    private class AlumnoReporte
    {
        public int Id { get; set; }
        public string Nombre { get; set; }
        public string Apellido { get; set; }
        public string Legajo { get; set; }
        public int? Nota { get; set; }
        public string Condicion { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var role = await AuthService.GetUserRoleAsync();
            if (role == null || role != "Administrador")
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await CargarCursos();
            await CargarMaterias();
            await CargarComisiones();
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task CargarCursos()
    {
        try
        {
            var result = await CursoApiClient.GetAllAsync();
            cursos = result?.ToList();
        }
        catch (Exception ex)
        {
            mensaje = $"Error al cargar cursos: {ex.Message}";
            esError = true;
        }
    }

    private async Task CargarMaterias()
    {
        try
        {
            var result = await MateriaApiClient.GetAllAsync();
            materias = result?.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar materias: {ex.Message}");
        }
    }

    private async Task CargarComisiones()
    {
        try
        {
            var result = await ComisionApiClient.GetAllAsync();
            comisiones = result?.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar comisiones: {ex.Message}");
        }
    }

    private async Task GenerarReporte()
    {
        try
        {
            if (cursoSeleccionadoId == 0)
            {
                mensaje = "Debe seleccionar un curso";
                esError = true;
                return;
            }

            cargando = true;
            mensaje = string.Empty;

            var curso = await CursoApiClient.GetAsync(cursoSeleccionadoId);
            if (curso == null)
            {
                mensaje = "Curso no encontrado";
                esError = true;
                cargando = false;
                return;
            }

            var inscripciones = await AlumnoInscripcionApiClient.GetAllAsync();
            var alumnosDelCurso = inscripciones.Where(i => i.CursoId == cursoSeleccionadoId).ToList();

            if (!alumnosDelCurso.Any())
            {
                mensaje = "No hay alumnos inscritos en este curso";
                esError = true;
                cargando = false;
                return;
            }

            var alumnos = new List<AlumnoReporte>();
            foreach (var inscripcion in alumnosDelCurso)
            {
                var usuario = await UsuarioApiClient.GetAsync(inscripcion.UsuarioId);
                var persona = await PersonaApiClient.GetAsync(usuario.PersonaId);

                alumnos.Add(new AlumnoReporte
                    {
                        Id = inscripcion.UsuarioId,
                        Nombre = persona.Nombre,
                        Apellido = persona.Apellido,
                        Legajo = usuario.Legajo,
                        Nota = inscripcion.Nota,
                        Condicion = ObtenerCondicion(inscripcion.Nota)
                    });
            }

            var comision = await ComisionApiClient.GetAsync(curso.ComisionId);
            var materia = await MateriaApiClient.GetAsync(curso.MateriaId);

            // Guardar datos del reporte
            alumnosReporte = alumnos.OrderBy(a => a.Apellido).ThenBy(a => a.Nombre).ToList();
            nombreCursoReporte = curso.Id.ToString();
            comisionCursoReporte = comision?.Nombre ?? "N/A";
            materiaCursoReporte = materia?.Descripcion ?? "N/A";
            profesorCursoReporte = "N/A";

            mensaje = "Reporte generado exitosamente";
            esError = false;
        }
        catch (Exception ex)
        {
            mensaje = $"Error al generar reporte: {ex.Message}";
            esError = true;
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task DescargarPDF()
    {
        try
        {
            if (alumnosReporte == null || alumnosReporte.Count == 0)
            {
                mensaje = "Debe generar un reporte primero";
                esError = true;
                return;
            }

            cargando = true;

            var pdf = GenerarPDFLocalamente();
            var fileName = $"Reporte_Alumnos_Curso_{cursoSeleccionadoId}_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            await js.InvokeVoidAsync("downloadFile", pdf, fileName);

            mensaje = "PDF descargado exitosamente";
            esError = false;
        }
        catch (Exception ex)
        {
            mensaje = $"Error al descargar PDF: {ex.Message}";
            esError = true;
        }
        finally
        {
            cargando = false;
        }
    }

    private byte[] GenerarPDFLocalamente()
    {
        QuestPDF.Settings.License = LicenseType.Community;

        var document = Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Margin(15);

                page.Header().Element(header => ConstruirEncabezado(header));
                page.Content().Element(content => ConstruirContenido(content));
                page.Footer().Element(footer => ConstruirPie(footer));
            });
        });

        return document.GeneratePdf();
    }

    private void ConstruirEncabezado(IContainer container)
    {
        container.Column(column =>
        {
            column.Item().Text("REPORTE DE ALUMNOS INSCRITOS")
                .FontSize(18).Bold().FontColor("#1f2937");

            column.Spacing(10);

            column.Item().Row(row =>
            {
                row.RelativeColumn().Element(col =>
                {
                    col.Text("INFORMACIÓN DEL CURSO").Bold().FontSize(11).FontColor("#3b82f6");
                });
            });

            column.Item().Row(row =>
            {
                row.RelativeColumn(2).Element(col =>
                {
                    col.Column(c =>
                    {
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Curso:").Bold();
                            r.RelativeColumn(2).Text(nombreCursoReporte).Bold().FontSize(11);
                        });
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Comisión:").Bold();
                            r.RelativeColumn(2).Text(comisionCursoReporte);
                        });
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Materia:").Bold();
                            r.RelativeColumn(2).Text(materiaCursoReporte);
                        });
                    });
                });

                row.RelativeColumn(1).Element(col =>
                {
                    col.Column(c =>
                    {
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Total Alumnos:").Bold();
                            r.RelativeColumn(2).Text(alumnosReporte.Count.ToString()).FontColor("#3b82f6").Bold();
                        });
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Fecha:").Bold();
                            r.RelativeColumn(2).Text(DateTime.Now.ToString("dd/MM/yyyy HH:mm"));
                        });
                    });
                });
            });

            column.Spacing(20);
        });
    }

    private void ConstruirContenido(IContainer container)
    {
        container.Column(column =>
        {
            column.Item().Table(table =>
            {
                table.ColumnsDefinition(columns =>
                {
                    columns.RelativeColumn(0.5f);
                    columns.RelativeColumn(2);
                    columns.RelativeColumn(2);
                    columns.RelativeColumn(1.5f);
                    columns.RelativeColumn(1);
                    columns.RelativeColumn(1.5f);
                });

                table.Header(header =>
                {
                    header.Cell().Background("#1f2937").Padding(8)
                        .Text("Nº").Bold().FontColor("#ffffff").FontSize(9);
                    header.Cell().Background("#1f2937").Padding(8)
                        .Text("Apellido").Bold().FontColor("#ffffff").FontSize(9);
                    header.Cell().Background("#1f2937").Padding(8)
                        .Text("Nombre").Bold().FontColor("#ffffff").FontSize(9);
                    header.Cell().Background("#1f2937").Padding(8)
                        .Text("Legajo").Bold().FontColor("#ffffff").FontSize(9);
                    header.Cell().Background("#1f2937").Padding(8)
                        .AlignCenter().Text("Nota").Bold().FontColor("#ffffff").FontSize(9);
                    header.Cell().Background("#1f2937").Padding(8)
                        .AlignCenter().Text("Condición").Bold().FontColor("#ffffff").FontSize(9);
                });

                int numero = 1;
                foreach (var alumno in alumnosReporte)
                {
                    var colorFondo = numero % 2 == 0 ? "#f3f4f6" : "#ffffff";

                    table.Cell().Background(colorFondo).Padding(6)
                        .Text(numero.ToString()).FontSize(9);
                    table.Cell().Background(colorFondo).Padding(6)
                        .Text(alumno.Apellido).FontSize(9);
                    table.Cell().Background(colorFondo).Padding(6)
                        .Text(alumno.Nombre).FontSize(9);
                    table.Cell().Background(colorFondo).Padding(6)
                        .Text(alumno.Legajo).FontSize(9);
                    table.Cell().Background(colorFondo).Padding(6)
                        .AlignCenter().Text($"{alumno.Nota?.ToString("F1") ?? "Sin nota"}").FontSize(9).Bold();

                    var colorCondicion = ObtenerColorCondicionPDF(alumno.Condicion);
                    table.Cell().Background(colorCondicion).Padding(6)
                        .AlignCenter().Text(alumno.Condicion).FontSize(8).Bold();

                    numero++;
                }
            });

            column.Spacing(30);

            var aprobados = alumnosReporte.Count(a => a.Condicion.ToLower() == "aprobado");
            var desaprobados = alumnosReporte.Count(a => a.Condicion.ToLower() == "desaprobado");
            var sinNota = alumnosReporte.Count(a => a.Condicion.ToLower() == "no cargada");
            var notasValidas = alumnosReporte.Where(a => a.Nota.HasValue && a.Nota > 0).ToList();
            var notaPromedio = notasValidas.Any() ? notasValidas.Average(a => a.Nota.Value) : 0;

            column.Item().BorderTop(1).BorderColor("#e5e7eb").PaddingTop(12)
                .Text("ESTADÍSTICAS").Bold().FontSize(11).FontColor("#1f2937");

            column.Item().Row(row =>
            {
                row.RelativeColumn().Element(col =>
                {
                    col.Column(c =>
                    {
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Aprobados:").Bold();
                            r.RelativeColumn(1).Text(aprobados.ToString()).FontColor("#10b981").Bold();
                        });
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Sin nota:").Bold();
                            r.RelativeColumn(1).Text(sinNota.ToString()).FontColor("#f97316").Bold();
                        });
                    });
                });

                row.RelativeColumn().Element(col =>
                {
                    col.Column(c =>
                    {
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Desaprobados:").Bold();
                            r.RelativeColumn(1).Text(desaprobados.ToString()).FontColor("#ef4444").Bold();
                        });
                        c.Item().Row(r =>
                        {
                            r.RelativeColumn(1).Text("Nota Promedio:").Bold();
                            r.RelativeColumn(1).Text($"{notaPromedio:F2}").FontColor("#8b5cf6").Bold();
                        });
                    });
                });
            });
        });
    }

    private void ConstruirPie(IContainer container)
    {
        container.Column(column =>
        {
            column.Item().BorderTop(1).BorderColor("#e5e7eb").PaddingTop(12)
                .AlignCenter().Text(text =>
                {
                    text.Span("Documento generado automáticamente - ");
                    text.Span($"{DateTime.Now:dd/MM/yyyy HH:mm:ss}");
                });
        });
    }

    private string ObtenerCondicion(int? nota)
    {
        if (nota is null)
            return "No cargada";
        if (nota < 6)
            return "Desaprobado";
        else
            return "Aprobado";
    }

    private string ObtenerColorCondicion(string condicion)
    {
        return condicion.ToLower() switch
        {
            "aprobado" => "bg-success",
            "desaprobado" => "bg-danger",
            "no cargada" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private string ObtenerColorCondicionPDF(string condicion)
    {
        return condicion.ToLower() switch
        {
            "aprobado" => "#d1fae5",
            "desaprobado" => "#fee2e2",
            "no cargada" => "#fed7aa",
            _ => "#ffffff"
        };
    }

    private string GetMateriaDesc(int materiaId)
    {
        if (materias == null) return "Desconocida";
        var materia = materias.FirstOrDefault(m => m.Id == materiaId);
        return materia?.Descripcion ?? "Desconocida";
    }

    private string GetComisionDesc(int comisionId)
    {
        if (comisiones == null) return "Desconocida";
        var comision = comisiones.FirstOrDefault(c => c.Id == comisionId);
        return comision?.Nombre ?? "Desconocida";
    }
}